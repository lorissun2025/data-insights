<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>竞品分析 - 智能数据平台</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@3.3.4/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.2/dist/axios.min.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="app">
        <nav class="navbar">
            <div class="nav-brand">DATA INSIGHTS</div>
            <div class="nav-menu">
                <a class="nav-item" href="dashboard.html">市场洞察</a>
                <a class="nav-item active" href="competitor.html">竞品分析</a>
                <a class="nav-item" href="forecast.html">销售预测</a>
                <a class="nav-item" href="customer.html">客户洞察</a>
                <a class="nav-item" href="price.html">价格分析</a>
                <a class="nav-item" href="supply-chain.html">智能供应链</a>
                <a class="nav-item" href="medical-performance.html">医疗效能</a>
                <a class="nav-item" href="investment.html">投资情报</a>
                <a class="nav-item" href="rwa.html">研发支持</a>
                <a class="nav-item" href="assistant.html">AI助手</a>
            </div>
            <div class="nav-user">
                <span class="user-name">{{ userName }}</span>
                <button class="logout-btn" @click="logout">退出登录</button>
            </div>
        </nav>

        <div class="header">
            <h1>竞品分析</h1>
            <p>多维度竞品对比与市场定位分析</p>
        </div>

        <div class="container">
            <div v-if="loading" class="loading">数据加载中...</div>

            <div v-else>
                <div class="chart-row">
                    <div class="chart-card">
                        <h3>竞品雷达图对比</h3>
                        <div ref="radarChart" class="chart-container"></div>
                    </div>
                    <div class="chart-card">
                        <h3>区域市场表现</h3>
                        <div ref="regionalChart" class="chart-container"></div>
                    </div>
                </div>

                <div class="table-card">
                    <h3>竞品列表及市场份额</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>竞品名称</th>
                                <th>市场份额</th>
                                <th>增长率</th>
                                <th>产品数量</th>
                                <th>竞争态势</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="comp in competitors" :key="comp.id">
                                <td>{{ comp.name }}</td>
                                <td>{{ comp.market_share }}%</td>
                                <td :style="{color: comp.growth > 0 ? '#10b981' : '#ef4444'}">
                                    {{ comp.growth > 0 ? '+' : '' }}{{ comp.growth }}%
                                </td>
                                <td>{{ comp.products }}个</td>
                                <td>
                                    <span class="tag" :class="comp.market_share > 20 ? 'high' : comp.market_share > 15 ? 'medium' : 'low'">
                                        {{ comp.market_share > 20 ? '强劲' : comp.market_share > 15 ? '中等' : '一般' }}
                                    </span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;
        const API_BASE = 'http://localhost:8000';

        createApp({
            data() {
                return {
                    loading: true,
                    userName: '管理员',
                    token: localStorage.getItem('token'),
                    competitors: []
                };
            },
            mounted() {
                if (!this.token) {
                    window.location.href = 'login.html';
                    return;
                }
                this.loadData();
            },
            methods: {
                logout() {
                    localStorage.removeItem('token');
                    window.location.href = 'login.html';
                },
                async loadData() {
                    try {
                        const [compRes, compListRes] = await Promise.all([
                            axios.get(`${API_BASE}/api/competitor/comparison`, {
                                headers: { Authorization: `Bearer ${this.token}` }
                            }),
                            axios.get(`${API_BASE}/api/competitor/list`, {
                                headers: { Authorization: `Bearer ${this.token}` }
                            })
                        ]);

                        this.competitors = compListRes.data.data;
                        this.comparisonData = compRes.data;

                        this.loading = false;
                        this.$nextTick(() => {
                            this.renderRadarChart();
                        });
                    } catch (error) {
                        console.error(error);
                        if (error.response?.status === 401) this.logout();
                    }
                },
                renderRadarChart() {
                    const chart = echarts.init(this.$refs.radarChart);
                    const data = this.comparisonData;

                    const option = {
                        tooltip: {
                            backgroundColor: 'rgba(15, 23, 42, 0.95)',
                            borderColor: 'rgba(99, 102, 241, 0.3)',
                            textStyle: { color: '#e2e8f0' }
                        },
                        legend: {
                            data: data.series.map(s => s.name),
                            top: 10,
                            textStyle: { color: '#94a3b8' }
                        },
                        radar: {
                            indicator: data.indicators.map(name => ({ name, max: 100 })),
                            shape: 'circle',
                            splitNumber: 5,
                            axisName: { color: '#94a3b8' },
                            splitLine: { lineStyle: { color: 'rgba(99, 102, 241, 0.2)' } },
                            splitArea: { areaStyle: { color: ['rgba(59, 130, 246, 0.05)', 'rgba(139, 92, 246, 0.05)'] } },
                            axisLine: { lineStyle: { color: 'rgba(99, 102, 241, 0.3)' } }
                        },
                        series: [{
                            name: '竞品对比',
                            type: 'radar',
                            data: data.series.map((s, i) => ({
                                value: s.value,
                                name: s.name,
                                itemStyle: { color: ['#3b82f6', '#8b5cf6', '#06b6d4'][i] },
                                areaStyle: { opacity: 0.3 }
                            }))
                        }]
                    };
                    chart.setOption(option);
                    window.addEventListener('resize', () => chart.resize());
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
